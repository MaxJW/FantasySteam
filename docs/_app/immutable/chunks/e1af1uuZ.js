import{q as T,w as U,c as P,g as j,a as S,u as k,d as b,b as d,s as M,e as R,f as z}from"./D36JPk-d.js";import{D as _,g as K,a as G,b as J,c as Q,d as V}from"./Gs9gDzk3.js";import{g as W}from"./Dkgqn7tu.js";const g="leagues",B="teams",X="drafts";function w(t){return b(d,g,t)}function F(t,a){return b(d,g,t,B,a)}function Z(t,a){return b(d,g,t,X,a)}async function v(t){const a=await S(w(t));return a.exists()?{id:a.id,...a.data()}:null}async function $(t){const a=T(P(d,g),U("code","==",t.trim().toUpperCase())),s=await j(a);if(s.empty)return null;const e=s.docs[0];return{id:e.id,...e.data()}}async function ft(t){const a=T(P(d,g),U("members","array-contains",t));return(await j(a)).docs.map(e=>({id:e.id,...e.data()}))}async function q(t){return(await j(P(d,g,t,B))).docs.map(s=>({id:s.id,...s.data()}))}async function H(t,a,s){const e=await S(Z(t,J(a,s)));return e.exists()?e.data().status:null}async function I(t,a){for(const s of _)if(await H(t,s,a)==="completed")return!0;return!1}async function tt(t,a){const s={};for(const e of _)s[e]=await H(t,e,a);return s}async function dt(t){const a=await v(t);if(!a)return;const s=await tt(t,a.season),e=K(s);e&&e!==a.currentPhase&&await k(w(t),{currentPhase:e})}function N(){return{winterPicks:[],summerPicks:[],fallPicks:[],altPicks:[]}}function at(){const t=new Date;return(t.getMonth()===11?t.getFullYear()+1:t.getFullYear()).toString()}const st="League code already in use";async function mt(t,a,s,e,u="My Studio"){const f=s.trim().toUpperCase();if(await $(f))throw new Error(st);const i=b(P(d,g)),l={name:a,code:f,commissionerId:t,settings:e,season:at(),status:"draft",currentPhase:"winter",members:[t],delistedGames:[],createdAt:R()};return await M(i,l),await M(F(i.id,t),{name:u.trim()||"My Studio",picks:N(),score:0,bombAdjustment:0}),i.id}async function gt(t,a,s="My Studio"){const e=await S(w(t));if(!e.exists())throw new Error("League not found");const u=e.data();if(u.members.includes(a))return;if(await I(t,u.season))throw new Error("Cannot join a league that is already in progress.");await k(w(t),{members:[...u.members,a]}),await M(F(t,a),{name:s.trim()||"My Studio",picks:N(),score:0,bombAdjustment:0})}async function pt(t){const a=await v(t);if(!a)throw new Error("League not found");const s=V(a.currentPhase);s?await k(w(t),{currentPhase:s,status:"active"}):await k(w(t),{status:"completed"})}async function wt(t){await z(w(t))}async function et(t,a){const s=await v(t),e=await q(t),u=s?.delistedGames??[],f=new Map,m=new Set;for(const o of e)G(o.picks,u).forEach(n=>m.add(n));const i=new Map;for(const o of m)try{let n=(await W(o)).map(r=>({date:r.date||"",points:r.dailyPoints}));a&&(n=n.filter(r=>r.date&&r.date<=a)),i.set(o,n)}catch{}const l=await j(P(d,"leagues",t,"scoring")),D=new Map;for(const o of l.docs){const c=o.data(),n=c.date??o.id;c.bombAdjustments&&(!a||n<=a)&&D.set(n,c.bombAdjustments)}const A=new Set;i.forEach(o=>{o.forEach(c=>A.add(c.date))});let p=Array.from(A).sort();a&&(p=p.filter(o=>o<=a));for(const o of e)f.set(o.id,new Map);for(let o=0;o<p.length;o++){const c=p[o],n=o>0?p[o-1]:null,r=new Map;for(const h of e){const E=G(h.picks,u);let L=0;for(const C of E){const x=i.get(C)?.find(Y=>Y.date===c);x&&(L+=x.points)}r.set(h.id,L)}const y=D.get(c)??{};for(const h of e){const E=f.get(h.id),L=n?E.get(n)??0:0,C=r.get(h.id)??0,x=y[h.id]??0;E.set(c,L+C+x)}}return f}const nt="seasonResults";function O(t,a){return b(d,g,t,nt,a)}async function ot(t,a){const s=await S(O(t,a));return s.exists()?s.data():null}async function rt(t,a){const s=Q(a),e=await et(t,s),u=await q(t),f=new Set;e.forEach(n=>{n.forEach((r,y)=>f.add(y))});const m=Array.from(f).sort(),i={};for(const n of u){const r=e.get(n.id),y=m[m.length-1];i[n.id]=y&&r?r.get(y)??0:0}const l=[...u].sort((n,r)=>(i[r.id]??0)-(i[n.id]??0)),D={};l.forEach((n,r)=>{D[n.id]=r+1});const A=l.map(n=>({teamId:n.id,data:m.map(r=>e.get(n.id)?.get(r)??0)})),p={finalScores:i,finalRanks:D,graphData:{dates:m,series:A},computedAt:R()},o=O(t,a),c=await S(o);return c.exists()?c.data():(await M(o,{...p,computedAt:R()}),(await S(o)).data())}async function lt(t,a){const s=await ot(t,a);return s||rt(t,a)}export{st as L,v as a,pt as b,mt as c,Z as d,ft as e,tt as f,$ as g,q as h,lt as i,gt as j,et as k,wt as l,dt as s,F as t};

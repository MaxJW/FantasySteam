import{q as G,w as v,c as w,g as P,a as M,u as D,d as b,b as c,s as L,e as _,f as N}from"./2_D5sMpC.js";import{D as T,g as Y,a as x,b as z,c as O,d as J}from"./DKVDk_7u.js";const d="leagues",R="teams",K="drafts";function u(t){return b(c,d,t)}function U(t,a){return b(c,d,t,R,a)}function Q(t,a){return b(c,d,t,K,a)}async function j(t){const a=await M(u(t));return a.exists()?{id:a.id,...a.data()}:null}async function V(t){const a=G(w(c,d),v("code","==",t.trim().toUpperCase())),e=await P(a);if(e.empty)return null;const s=e.docs[0];return{id:s.id,...s.data()}}async function et(t){const a=G(w(c,d),v("members","array-contains",t));return(await P(a)).docs.map(s=>({id:s.id,...s.data()}))}async function W(t){return(await P(w(c,d,t,R))).docs.map(e=>({id:e.id,...e.data()}))}async function F(t,a,e){const s=await M(Q(t,O(a,e)));return s.exists()?s.data().status:null}async function X(t,a){for(const e of T)if(await F(t,e,a)==="completed")return!0;return!1}async function Z(t,a){const e={};for(const s of T)e[s]=await F(t,s,a);return e}async function st(t){const a=await j(t);if(!a)return;const e=await Z(t,a.season),s=Y(e);s&&s!==a.currentPhase&&await D(u(t),{currentPhase:s})}function q(){return{winterPicks:[],summerPicks:[],fallPicks:[],altPicks:[]}}function $(){const t=new Date;return(t.getMonth()===11?t.getFullYear()+1:t.getFullYear()).toString()}const I="League code already in use";async function nt(t,a,e,s,r="My Studio"){const f=e.trim().toUpperCase();if(await V(f))throw new Error(I);const g=b(w(c,d)),l={name:a,code:f,commissionerId:t,settings:s,season:$(),status:"draft",currentPhase:"winter",members:[t],delistedGames:[],createdAt:_()};return await L(g,l),await L(U(g.id,t),{name:r.trim()||"My Studio",picks:q(),score:0,bombAdjustment:0}),g.id}async function ot(t,a,e="My Studio"){const s=await M(u(t));if(!s.exists())throw new Error("League not found");const r=s.data();if(r.members.includes(a))return;if(await X(t,r.season))throw new Error("Cannot join a league that is already in progress.");await D(u(t),{members:[...r.members,a]}),await L(U(t,a),{name:e.trim()||"My Studio",picks:q(),score:0,bombAdjustment:0})}async function rt(t){const a=await j(t);if(!a)throw new Error("League not found");const e=J(a.currentPhase);e?await D(u(t),{currentPhase:e,status:"active"}):await D(u(t),{status:"completed"})}async function ct(t){await N(u(t))}async function it(t){const a=await j(t),e=await W(t),s=a?.delistedGames??[],r=new Map,f=new Set;for(const n of e)x(n.picks,s).forEach(i=>f.add(i));const p=new Map;for(const n of f)try{const o=await z(n);p.set(n,o.map(i=>({date:i.date||"",points:i.dailyPoints})))}catch{}const g=await P(w(c,"leagues",t,"scoring")),l=new Map;for(const n of g.docs){const o=n.data();o.bombAdjustments&&l.set(o.date??n.id,o.bombAdjustments)}const k=new Set;p.forEach(n=>{n.forEach(o=>k.add(o.date))});const E=Array.from(k).sort();for(const n of e)r.set(n.id,new Map);for(let n=0;n<E.length;n++){const o=E[n],i=n>0?E[n-1]:null,C=new Map;for(const m of e){const y=x(m.picks,s);let h=0;for(const A of y){const S=p.get(A)?.find(H=>H.date===o);S&&(h+=S.points)}C.set(m.id,h)}const B=l.get(o)??{};for(const m of e){const y=r.get(m.id),h=i?y.get(i)??0:0,A=C.get(m.id)??0,S=B[m.id]??0;y.set(o,h+A+S)}}return r}export{I as L,j as a,rt as b,nt as c,Q as d,et as e,Z as f,V as g,W as h,it as i,ot as j,ct as k,st as s,U as t};

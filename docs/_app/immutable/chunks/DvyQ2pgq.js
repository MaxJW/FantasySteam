import{q as U,w as N,a as T,b as E,d as M,u as j,e as L,f as p,h as x,i as C,j as $}from"./CUsvRYbg.js";import{D as F,g as J,a as B,b as Q,c as V,d as W}from"./nK_5IJdR.js";import{g as _}from"./Z1YjaJz3.js";const l="leagues",H="teams",X="drafts";function A(t){return L(p,l,t)}function q(t,a){return L(p,l,t,H,a)}function Z(t,a){return L(p,l,t,X,a)}async function G(t){const a=await M(A(t));return a.exists()?{id:a.id,...a.data()}:null}async function I(t){const a=U(T(p,l),N("code","==",t.trim().toUpperCase())),s=await E(a);if(s.empty)return null;const e=s.docs[0];return{id:e.id,...e.data()}}async function ut(t){const a=U(T(p,l),N("members","array-contains",t));return(await E(a)).docs.map(e=>({id:e.id,...e.data()}))}async function O(t){return(await E(T(p,l,t,H))).docs.map(s=>({id:s.id,...s.data()}))}async function z(t,a,s){const e=await M(Z(t,Q(a,s)));return e.exists()?e.data().status:null}async function tt(t,a){for(const s of F)if(await z(t,s,a)==="completed")return!0;return!1}async function at(t,a){const s={};for(const e of F)s[e]=await z(t,e,a);return s}async function mt(t){const a=await G(t);if(!a)return;const s=await at(t,a.season),e=J(s,a.season);if(e&&e!==a.currentPhase){const d={currentPhase:e};a.status==="draft"&&(d.status="active"),await j(A(t),d)}}function K(){return{winterPicks:[],summerPicks:[],fallPicks:[],altPicks:[]}}function et(){const t=new Date;return(t.getMonth()===11?t.getFullYear()+1:t.getFullYear()).toString()}const st="League code already in use";async function gt(t,a,s,e,d="My Studio"){const u=s.trim().toUpperCase();if(await I(u))throw new Error(st);const f=L(T(p,l)),w={name:a,code:u,commissionerId:t,settings:e,season:et(),status:"draft",currentPhase:"winter",members:[t],delistedGames:[],createdAt:C()};return await x(f,w),await x(q(f.id,t),{name:d.trim()||"My Studio",picks:K(),score:0,bombAdjustment:0}),f.id}async function pt(t,a,s="My Studio"){const e=await M(A(t));if(!e.exists())throw new Error("League not found");const d=e.data();if(d.members.includes(a))return;if(await tt(t,d.season))throw new Error("Cannot join a league that is already in progress.");await j(A(t),{members:[...d.members,a]}),await x(q(t,a),{name:s.trim()||"My Studio",picks:K(),score:0,bombAdjustment:0})}async function wt(t){const a=await G(t);if(!a)throw new Error("League not found");const s=W(a.currentPhase);s?await j(A(t),{currentPhase:s,status:"active"}):await j(A(t),{status:"completed"})}async function lt(t){await $(A(t))}async function nt(t,a){const s=await G(t),e=await O(t),d=s?.delistedGames??[],u=new Map,m=new Set;for(const o of e)B(o.picks,d).forEach(n=>m.add(n));const f=new Map;for(const o of m)try{let n=(await _(o)).map(r=>({date:r.date||"",points:r.dailyPoints}));a&&(n=n.filter(r=>r.date&&r.date<=a)),f.set(o,n)}catch{}const w=await E(T(p,"leagues",t,"scoring")),h=new Map;for(const o of w.docs){const c=o.data(),n=c.date??o.id;c.bombAdjustments&&(!a||n<=a)&&h.set(n,c.bombAdjustments)}const S=new Set;f.forEach(o=>{o.forEach(c=>S.add(c.date))});let i=Array.from(S).sort();a&&(i=i.filter(o=>o<=a));for(const o of e)u.set(o.id,new Map);for(let o=0;o<i.length;o++){const c=i[o],n=o>0?i[o-1]:null,r=new Map;for(const y of e){const b=B(y.picks,d);let P=0;for(const D of b){const k=f.get(D)?.find(v=>v.date===c);k&&(P+=k.points)}r.set(y.id,P)}const g=h.get(c)??{};for(const y of e){const b=u.get(y.id),P=n?b.get(n)??0:0,D=r.get(y.id)??0,k=g[y.id]??0;b.set(c,P+D+k)}}return u}async function yt(t,a,s,e){const d=a.length;if(d<2)return{};const u=await E(T(p,l,t,"scoring")),m=new Map;a.forEach(i=>m.set(i.id,new Map));const f=new Set;for(const i of a){const o=i.picks?.bombPick;o&&f.add(o)}if(f.size===0)return{};const w=new Map;for(const i of f)try{const o=await _(i),c=new Map;for(const n of o)n.date&&(!e||n.date<=e)&&c.set(n.date,n.dailyPoints??0);w.set(i,c)}catch{}const h=d-1;for(const i of u.docs){const o=i.data(),c=o.date??i.id;if(e&&c>e)continue;const n=o.bombThreshold??0;if(!(n<=0))for(const r of a){const g=r.picks?.bombPick;if(!g)continue;const y=w.get(g)?.get(c)??0,b=Math.max(0,n-y);if(b<=0)continue;const P=b/h;for(const D of a){if(D.id===r.id)continue;const k=`${r.id}:${g}`,v=m.get(D.id),R=v.get(k);R?R.damage-=P:v.set(k,{gameId:g,pickerTeamName:r.name,damage:-P})}}}const S={};for(const i of a){const o=Array.from(m.get(i.id).values()).filter(c=>c.damage<0).map(c=>({gameId:c.gameId,gameName:s[c.gameId]?.name??"Unknown",pickerTeamName:c.pickerTeamName,damage:c.damage})).sort((c,n)=>c.damage-n.damage);S[i.id]=o}return S}const ot="seasonResults";function Y(t,a){return L(p,l,t,ot,a)}async function ct(t,a){const s=await M(Y(t,a));return s.exists()?s.data():null}async function rt(t,a){const s=V(a),e=await nt(t,s),d=await O(t),u=new Set;e.forEach(n=>{n.forEach((r,g)=>u.add(g))});const m=Array.from(u).sort(),f={};for(const n of d){const r=e.get(n.id),g=m[m.length-1];f[n.id]=g&&r?r.get(g)??0:0}const w=[...d].sort((n,r)=>(f[r.id]??0)-(f[n.id]??0)),h={};w.forEach((n,r)=>{h[n.id]=r+1});const S=w.map(n=>({teamId:n.id,data:m.map(r=>e.get(n.id)?.get(r)??0)})),i={finalScores:f,finalRanks:h,graphData:{dates:m,series:S},computedAt:C()},o=Y(t,a),c=await M(o);return c.exists()?c.data():(await x(o,{...i,computedAt:C()}),(await M(o)).data())}async function ht(t,a){const s=await ct(t,a);return s||rt(t,a)}export{st as L,G as a,wt as b,gt as c,Z as d,ut as e,at as f,I as g,O as h,ht as i,pt as j,nt as k,yt as l,lt as m,mt as s,q as t};
